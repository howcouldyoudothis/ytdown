<!--
  Simple YouTube Downloader â€” GitHub Pages Client (v4)
  ============================================================== 
  LEGAL NOTICE:
  Downloading videos from YouTube without permission may violate YouTubeâ€™s Terms
  of Service and/or copyright law.  Use this tool only on videos you have the
  rights to or that are explicitly licensed for download.

  ðŸ”§  WHAT CHANGED (v4)
  ---------------------------------------------------------------------------
  â€¢ **Multiâ€‘proxy CORS chain** â€” tries 3 public CORS proxies (isomorphicâ€‘git, 
    thingproxy, AllOrigins) after a direct fetch, greatly increasing success rate.
  â€¢ **Rotating Piped instances** â€” if the first Piped node is down or blocks us,
    the code automatically tries two alternates.
  â€¢ Clear perâ€‘proxy error reporting so we can see exactly which host failed.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YouTube Downloader</title>
  <style>
    :root{--accent:#2563eb;--radius:.375rem;--border:#d1d5db;--subtle:#6b7280;--bg:#f3f4f6;}
    *,*::before,*::after{box-sizing:border-box;}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:var(--bg);margin:0;padding:2rem 1rem;display:flex;flex-direction:column;align-items:center;min-height:100vh;}
    h1{margin:0 0 1rem;text-align:center;}
    p.small{font-size:.9rem;color:var(--subtle);max-width:640px;text-align:center;}
    form{display:flex;gap:.5rem;width:100%;max-width:520px;margin-top:1rem;}
    input[type=url]{flex:1;padding:.6rem .8rem;font-size:1rem;border:1px solid var(--border);border-radius:var(--radius);}
    button{padding:.6rem 1rem;font-size:1rem;border:none;border-radius:var(--radius);background:var(--accent);color:#fff;cursor:pointer;transition:background .2s;}
    button:hover{background:#1d4ed8;}
    #results{margin-top:2rem;width:100%;max-width:760px;}
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    th,td{padding:.6rem .5rem;text-align:left;border-bottom:1px solid var(--border);font-size:.95rem;}
    th{background:#f9fafb;font-weight:600;}
    tr:last-child td{border-bottom:none;}
    a.download-btn{color:var(--accent);text-decoration:none;font-weight:600;}
    .error{color:#b91c1c;white-space:pre-wrap;}
    .muted{color:var(--subtle);font-size:.88rem;white-space:pre-wrap;}
  </style>
</head>
<body>
  <h1>YouTube Downloader</h1>
  <p class="small">
    Paste a YouTube URL, select a quality, or grab <em>audioâ€‘only</em> for MP3.
    The script tries <strong>Yozora</strong> first, then rotates over multiple
    <strong>Piped</strong> instances.  A builtâ€‘in multiâ€‘proxy chain handles CORS
    so it works right from GitHub Pages.<br><br>
    <strong>Download responsibly.</strong>
  </p>

  <form id="dl-form">
    <input id="yt-url" type="url" placeholder="https://www.youtube.com/watch?v=dQw4w9WgXcQ" required />
    <button type="submit">Get Links</button>
  </form>

  <div id="results"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Helpers & Config
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const form    = document.getElementById('dl-form');
const input   = document.getElementById('yt-url');
const results = document.getElementById('results');

// Rotate through several public CORS proxies after direct fetch
const PROXIES = [
  url => url, // direct attempt (no proxy)
  url => `https://cors.isomorphic-git.org/${url}`,
  url => `https://thingproxy.freeboard.io/fetch/${url}`,
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`
];

// Multiple Piped instances
const PIPED_NODES = [
  'https://piped.video',          // often CORSâ€‘open
  'https://pipedapi.kavin.rocks',
  'https://piped.getalby.eu'
];

const fmtBytes = (b=0)=>{if(!b) return 'â€”';const k=1024,s=['B','KB','MB','GB','TB'],i=Math.floor(Math.log(b)/Math.log(k));return `${(b/Math.pow(k,i)).toFixed(1)} ${s[i]}`};
const vidId    = url=>{const m=url.match(/(?:v=|\/|^)([0-9A-Za-z_-]{11})(?:[?&].*)?$/);return m?m[1]:null;};

// Try each proxy in order until one succeeds
async function fetchJson(url){
  const errs=[];
  for(const make of PROXIES){
    const target = make(url);
    try{
      const res = await fetch(target);
      if(res.ok) return res.json();
      errs.push(`${new URL(target).hostname}: ${res.status}`);
    }catch(e){ errs.push(`${new URL(target).hostname}: ${e.message}`); }
  }
  throw new Error('All proxies failed â†’ '+errs.join(' | '));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Yozora (primary) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchYozora(videoUrl){
  const api = `https://yozora.vercel.app/api/info?query=${encodeURIComponent(videoUrl)}`;
  const j   = await fetchJson(api);
  if(!Array.isArray(j.formats)) throw new Error('Unexpected Yozora payload');
  return j.formats.map(f=>({
    type: f.vcodec!=='none' ? 'Video' : 'Audio',
    quality: f.vcodec!=='none' ? (f.format_note || `${f.height}p`) : `${f.abr||'?'} kbps`,
    size: f.filesize,
    ext:  f.ext,
    url:  `https://yozora.vercel.app/api/download?url=${encodeURIComponent(videoUrl)}&format=${encodeURIComponent(f.format_id)}`
  }));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Piped (fallback) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchPiped(videoUrl){
  const id = vidId(videoUrl);
  if(!id) throw new Error('Cannot parse video ID');

  const errs=[];
  for(const base of PIPED_NODES){
    try{
      const j   = await fetchJson(`${base}/streams/${id}`);
      const all = [...(j.videoStreams||[]), ...(j.audioStreams||[])];
      if(!all.length) throw new Error('No streams');
      return all.map(s=>({
        type: s.videoOnly ? 'Video' : 'Audio',
        quality: s.quality || (s.bitrate ? `${Math.round(s.bitrate/1000)} kbps` : 'â€”'),
        size: s.size,
        ext:  s.container,
        url:  s.url
      }));
    }catch(e){ errs.push(`${new URL(base).hostname}: ${e.message}`); }
  }
  throw new Error('All Piped nodes failed â†’ '+errs.join(' | '));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ UI Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(rows){
  const table=document.createElement('table');
  table.innerHTML='<thead><tr><th>Type</th><th>Quality/Bitrate</th><th>Size</th><th>Ext</th><th></th></tr></thead><tbody></tbody>';
  const tbody=table.querySelector('tbody');
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.type}</td><td>${r.quality}</td><td>${fmtBytes(r.size)}</td><td>${r.ext}</td><td><a class="download-btn" href="${r.url}" target="_blank" rel="noopener">Download</a></td>`;
    tbody.appendChild(tr);
  });
  return table;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Main submit handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
form.addEventListener('submit',async e=>{
  e.preventDefault();
  const url = input.value.trim();
  if(!url) return;
  results.innerHTML='<p class="muted">Fetching video infoâ€¦</p>';

  try{
    const rows = await fetchYozora(url);
    results.innerHTML='';
    results.appendChild(render(rows));
  }catch(err1){
    console.warn('Yozora failed',err1.message);
    try{
      const rows = await fetchPiped(url);
      results.innerHTML='<p class="muted">Primary API failed, using Piped.</p>';
      results.appendChild(render(rows));
    }catch(err2){
      console.error('Piped failed',err2.message);
      results.innerHTML=`<p class="error">Failed with both APIs.\n\nYozora â†’ ${err1.message}\nPiped â†’ ${err2.message}\n\nTip: Wait a minute, or host your own ytâ€‘dlp worker with CORS enabled.</p>`;
    }
  }
});
</script>
</body>
</html>
